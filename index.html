<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Absensi User</title>
    <style>
        body {
            font-family: Arial;
            background: #0f172a;
            color: white;
            text-align: center;
            padding: 40px;
        }
        .card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            display: inline-block;
            width: 300px;
        }
        input {
            padding: 10px;
            width: 90%;
            margin: 10px 0;
            border-radius: 6px;
            border: none;
        }
        button {
            padding: 10px 20px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        .on { background: #22c55e; }
        .off { background: #ef4444; }
        .logout { background: #64748b; }
        .week {
            margin-bottom: 15px;
            font-size: 18px;
        }
    </style>
</head>
<body>

<h2>Absensi Karyawan</h2>

<div class="week" id="weekTime"></div>

<div class="card" id="loginCard">
    <h3>Login</h3>
    <input type="text" id="username" placeholder="Masukkan nama">
    <button onclick="login()">Login</button>
</div>

<div class="card" id="absenCard" style="display:none;">
    <h3 id="welcome"></h3>
    <button class="on" onclick="onDuty()">ON DUTY</button>
    <button class="off" onclick="offDuty()">OFF DUTY</button>
    <br>
    <button class="logout" onclick="logout()">Logout</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbx3l8XlVqeskN4Y10bIwxp4kYFGfsqGxc3u_DWUgLNA-RUwwD_DSDMdbKM-HtlTG5sC/exec";

let user = localStorage.getItem("user");
let logs = JSON.parse(localStorage.getItem("logs") || "[]");

function saveLogs() {
    localStorage.setItem("logs", JSON.stringify(logs));
}

function login() {
    const name = document.getElementById("username").value;
    if (!name) return alert("Masukkan nama");

    localStorage.setItem("user", name);
    location.reload();
}

function logout() {
    localStorage.removeItem("user");
    location.reload();
}

function showUI() {
    if (user) {
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("absenCard").style.display = "block";
        document.getElementById("welcome").innerText = "Halo, " + user;
    }
}

async function sendToDiscord(status, keterangan="") {
    const waktu = new Date().toLocaleString();

    await fetch(API, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nama: user,
            status,
            keterangan,
            waktu
        })
    });
}

function onDuty() {
    const now = Date.now();
    logs.push({ type: "on", time: now });
    saveLogs();
    sendToDiscord("ON DUTY");
    updateWeekTime();
    alert("ON DUTY berhasil");
}

function offDuty() {
    const ket = prompt("Kegiatan hari ini?");
    const now = Date.now();
    logs.push({ type: "off", time: now });
    saveLogs();
    sendToDiscord("OFF DUTY", ket);
    updateWeekTime();
    alert("OFF DUTY berhasil");
}

function updateWeekTime() {
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    let total = 0;
    let lastOn = null;

    logs.forEach(log => {
        if (log.time < weekAgo) return;

        if (log.type === "on") {
            lastOn = log.time;
        }
        if (log.type === "off" && lastOn) {
            total += log.time - lastOn;
            lastOn = null;
        }
    });

    const hours = Math.floor(total / (1000 * 60 * 60));
    const mins = Math.floor((total / (1000 * 60)) % 60);

    document.getElementById("weekTime").innerText =
        "Total kerja minggu ini: " + hours + " jam " + mins + " menit";
}

showUI();
updateWeekTime();
</script>

</body>
</html>

