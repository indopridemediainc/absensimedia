<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Absensi</title>
<style>
body {
    font-family: Arial;
    background: #0f172a;
    color: white;
    text-align: center;
    padding: 30px;
}
.container {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
}
.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 12px;
    width: 320px;
}
button {
    padding: 10px 15px;
    margin: 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.on { background: #22c55e; }
.off { background: #ef4444; }
.logout { background: #64748b; }
table {
    width: 100%;
    font-size: 13px;
}
td { padding: 4px; }
</style>
</head>
<body>

<h2>ABSENSI STAFF IMI</h2>

<div id="loginCard" class="card">
    <h3>Login</h3>
    <input type="text" id="username" placeholder="Masukkan nama">
    <br><br>
    <button onclick="login()">Login</button>
</div>

<div class="container" id="mainUI" style="display:none;">

    <div class="card">
        <h3 id="welcome"></h3>
        <button class="on" onclick="onDuty()">ON DUTY</button>
        <button class="off" onclick="offDuty()">OFF DUTY</button>
        <br><br>
        <button class="logout" onclick="logout()">Logout</button>
        <hr>
        <div id="totalTime">Total minggu ini: 0 jam</div>
    </div>

    <div class="card">
        <h3>History</h3>
        <table id="historyTable"></table>
    </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx3l8XlVqeskN4Y10bIwxp4kYFGfsqGxc3u_DWUgLNA-RUwwD_DSDMdbKM-HtlTG5sC/exec";
let user = localStorage.getItem("user");

function login() {
    const name = document.getElementById("username").value;
    if (!name) return alert("Masukkan nama");
    localStorage.setItem("user", name);
    location.reload();
}

function logout() {
    localStorage.removeItem("user");
    location.reload();
}

function showUI() {
    if (user) {
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("mainUI").style.display = "flex";
        document.getElementById("welcome").innerText = "Halo, " + user;
        loadHistory();
    }
}

async function send(status, ket="") {
    await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nama: user,
            status,
            keterangan: ket
        })
    });
}

function onDuty() {
    send("ON DUTY");
    alert("ON DUTY berhasil");
    loadHistory();
}

function offDuty() {
    const ket = prompt("Kegiatan hari ini?");
    send("OFF DUTY", ket);
    alert("OFF DUTY berhasil");
    loadHistory();
}

async function loadHistory() {
    const res = await fetch(API_URL);
    const data = await res.json();

    const userLogs = data.filter(d => d.nama === user);
    const table = document.getElementById("historyTable");
    table.innerHTML = "";

    let total = 0;
    let lastOn = null;
    const weekAgo = Date.now() - (7*24*60*60*1000);

    userLogs.forEach(log => {
        const time = new Date(log.waktu).getTime();

        table.innerHTML += `
            <tr>
                <td>${new Date(log.waktu).toLocaleString()}</td>
                <td>${log.status}</td>
            </tr>
        `;

        if (time < weekAgo) return;

        if (log.status === "ON DUTY") lastOn = time;
        if (log.status === "OFF DUTY" && lastOn) {
            total += time - lastOn;
            lastOn = null;
        }
    });

    const hours = Math.floor(total / 3600000);
    const mins = Math.floor((total % 3600000) / 60000);

    document.getElementById("totalTime").innerText =
        `Total minggu ini: ${hours} jam ${mins} menit`;
}

showUI();
</script>
</body>
</html>
